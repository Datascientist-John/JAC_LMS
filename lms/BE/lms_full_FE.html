<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LMS | Professional UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --primary:#5b6cff;
    --bg:#f4f6fb;
    --dark:#1f2937;
    --card:#ffffff;
    --success:#16a34a;
    --danger:#dc2626;
}
* { box-sizing: border-box; }
body {
    margin: 0;
    font-family: "Segoe UI", system-ui, sans-serif;
    background: var(--bg);
    color: var(--dark);
}
.container {
    max-width: 1100px;
    margin: auto;
    padding: 30px;
}
.center-box {
    max-width: 420px;
    margin: 80px auto;
}
.card {
    background: var(--card);
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0,0,0,.08);
    margin-bottom: 20px;
}
.hidden { display:none; }

h1,h2 { margin-top:0; }

input, select, textarea {
    width:100%;
    padding:12px;
    margin-top:8px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:15px;
    font-family: inherit;
}
textarea {
    min-height: 100px;
    resize: vertical;
}
button {
    width:100%;
    padding:12px;
    margin-top:15px;
    border:none;
    border-radius:8px;
    background:var(--primary);
    color:white;
    font-size:16px;
    cursor:pointer;
    transition: opacity 0.2s;
}
button:hover { opacity:.9; }
button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
button.secondary {
    background: #6b7280;
}
button.success {
    background: var(--success);
}
button.small {
    width: auto;
    padding: 8px 16px;
    font-size: 14px;
    margin-top: 0;
}

.link {
    margin-top:15px;
    text-align:center;
    color:var(--primary);
    cursor:pointer;
}

.error { color:var(--danger); margin-top:10px; }
.success { color:var(--success); margin-top:10px; }

.topbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
}
.course {
    padding:15px;
    background:#f9fafb;
    border-radius:10px;
    margin-bottom:12px;
    border: 2px solid transparent;
    transition: border-color 0.2s;
}
.course:hover {
    border-color: var(--primary);
}
.course-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 10px;
}
.course-title {
    font-size: 18px;
    font-weight: bold;
    color: var(--dark);
}
.course-meta {
    color: #6b7280;
    font-size: 14px;
    margin: 8px 0;
}
.badge {
    display:inline-block;
    padding:4px 10px;
    background:var(--primary);
    color:white;
    border-radius:20px;
    font-size:13px;
    margin-left: 8px;
}
.badge.enrolled {
    background: var(--success);
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--dark);
}
</style>
</head>

<body>

<div class="container">

<!-- ================= AUTH ================= -->
<div id="auth" class="center-box card">
    <h1 id="authTitle">Login</h1>
    <div id="authMsg"></div>

    <!-- LOGIN -->
    <div id="loginForm">
        <input id="loginEmail" placeholder="Email">
        <input id="loginPassword" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <div class="link" onclick="switchAuth('register')">
            Don't have an account? Register
        </div>
    </div>

    <!-- REGISTER -->
    <div id="registerForm" class="hidden">
        <input id="regName" placeholder="Full Name">
        <input id="regEmail" placeholder="Email">
        <input id="regPassword" type="password" placeholder="Password">
        <select id="regRole">
            <option value="student">Student</option>
            <option value="instructor">Instructor</option>
        </select>
        <button onclick="register()">Create Account</button>
        <div class="link" onclick="switchAuth('login')">
            Already have an account? Login
        </div>
    </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="hidden">
    <div class="topbar">
        <div>
            <h2 id="userName"></h2>
            <span class="badge" id="userRole"></span>
        </div>
        <button class="small" onclick="logout()">Logout</button>
    </div>

    <!-- CREATE COURSE (Instructors Only) -->
    <div id="createCourseSection" class="card hidden">
        <h2> Create New Course</h2>
        <div id="createCourseMsg"></div>
        <div class="form-group">
            <label>Course Title</label>
            <input id="courseTitle" placeholder="e.g., Introduction to Python">
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="courseDescription" placeholder="Brief description of the course"></textarea>
        </div>
        <div class="form-group">
            <label>Level</label>
            <select id="courseLevel">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>
        <div class="form-group">
            <label>Duration</label>
            <input id="courseDuration" placeholder="e.g., 6 weeks, 10 hours">
        </div>
        <button onclick="createCourse()">Create Course</button>
    </div>

    <!-- COURSES LIST -->
    <div class="card">
        <h2>Courses</h2>
        <div id="courses">Loading...</div>
    </div>

    <!-- PROFILE -->
    <div class="card">
        <h2> My Profile</h2>
        <div id="profile"></div>
    </div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API = "http://localhost:8000";
let currentUser = null;

/* ================= SAFE JAC CALL ================= */
async function callWalker(name, params = {}) {
    try {
        const res = await fetch(`${API}/walker/${name}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params)
        });

        const json = await res.json();
        return json;
    } catch (error) {
        console.error("API Error:", error);
        return { success: false, message: "Failed to connect to server" };
    }
}

/* ================= AUTH UI ================= */
function switchAuth(mode) {
    authMsg.innerHTML = "";
    loginForm.classList.toggle("hidden", mode !== "login");
    registerForm.classList.toggle("hidden", mode !== "register");
    authTitle.textContent = mode === "login" ? "Login" : "Register";
}

/* ================= AUTH LOGIC ================= */
async function login() {
    const response = await callWalker("login_user", {
        email: loginEmail.value,
        password: loginPassword.value
    });

    const data = response.reports?.[0] || response;

    if (!data.success) {
        const msg = data.message || data.error || "Invalid email or password.";
        authMsg.innerHTML = `<div class="error">${msg}</div>`;
        return;
    }

    currentUser = data.user || response.result?.user;
    showDashboard();
}

async function register() {
    const response = await callWalker("register_user", {
        name: regName.value,
        email: regEmail.value,
        password: regPassword.value,
        role: regRole.value
    });

    const data = response.reports?.[0] || response;

    const msg = data.message || data.error || 
        (data.success ? "Registration successful." : "Registration failed.");

    authMsg.innerHTML = data.success
        ? `<div class="success">${msg}</div>`
        : `<div class="error">${msg}</div>`;

    if (data.success) {
        setTimeout(() => switchAuth("login"), 1500);
    }
}

/* ================= DASHBOARD ================= */
function showDashboard() {
    auth.classList.add("hidden");
    dashboard.classList.remove("hidden");

    userName.textContent = currentUser.name;
    userRole.textContent = currentUser.role;

    // Show create course section for instructors
    if (currentUser.role === "instructor") {
        createCourseSection.classList.remove("hidden");
    }

    loadCourses();
    loadProfile();
}

function logout() {
    location.reload();
}

/* ================= COURSE MANAGEMENT ================= */
async function createCourse() {
    const title = courseTitle.value.trim();
    const description = courseDescription.value.trim();
    const level = courseLevel.value;
    const duration = courseDuration.value.trim();

    if (!title || !description || !duration) {
        createCourseMsg.innerHTML = '<div class="error">Please fill in all fields</div>';
        return;
    }

    const response = await callWalker("create_course", {
        title: title,
        description: description,
        instructor: currentUser.name,
        level: level,
        duration: duration
    });

    const data = response.reports?.[0] || response;

    const msg = data.message || (data.success ? "Course created successfully!" : "Failed to create course");

    createCourseMsg.innerHTML = data.success
        ? `<div class="success">${msg}</div>`
        : `<div class="error">${msg}</div>`;

    if (data.success) {
        courseTitle.value = "";
        courseDescription.value = "";
        courseDuration.value = "";
        courseLevel.value = "beginner";
        setTimeout(() => {
            createCourseMsg.innerHTML = "";
            loadCourses();
        }, 2000);
    }
}

async function enrollInCourse(courseId, courseTitle) {
    if (!confirm(`Do you want to enroll in "${courseTitle}"?`)) {
        return;
    }

    const response = await callWalker("enroll_course", {
        user_id: currentUser.id,
        course_id: courseId
    });

    const data = response.reports?.[0] || response;

    if (data.success) {
        alert("Successfully enrolled!");
        loadCourses();
        loadProfile();
    } else {
        alert(data.message || "Enrollment failed");
    }
}

/* ================= DATA ================= */
async function loadCourses() {
    courses.innerHTML = "Loading...";
    
    const response = await callWalker("get_courses");
    
    // The courses are directly in reports[0] as an array
    const list = response.reports?.[0] || [];
    
    if (list.length === 0) {
        courses.innerHTML = "<p>No courses available yet.</p>";
        return;
    }

    // Get user's enrolled courses
    const profileResponse = await callWalker("get_user_profile", {
        user_id: currentUser.id
    });
    const profileData = profileResponse.reports?.[0] || profileResponse;
    const enrolledCourses = profileData.user?.enrolled_courses || [];

    courses.innerHTML = list.map(c => {
        const isEnrolled = enrolledCourses.includes(c.title);
        const isStudent = currentUser.role === "student";
        
        return `
            <div class="course">
                <div class="course-header">
                    <div>
                        <div class="course-title">
                            ${c.title}
                            ${isEnrolled ? '<span class="badge enrolled">Enrolled</span>' : ''}
                        </div>
                    </div>
                </div>
                <p>${c.description}</p>
                <div class="course-meta">
                     ${c.instructor} |  ${c.level} | ‚è± ${c.duration} | üë• ${c.enrolled_count || 0} enrolled
                </div>
                ${isStudent && !isEnrolled ? 
                    `<button class="small success" onclick="enrollInCourse('${c.id}', '${c.title.replace(/'/g, "\\'")}')">
                        Enroll Now
                    </button>` 
                    : ''}
            </div>
        `;
    }).join("");
}

async function loadProfile() {
    const response = await callWalker("get_user_profile", {
        user_id: currentUser.id
    });

    const data = response.reports?.[0] || response;
    const user = data.user || {};

    profile.innerHTML = `
        <p><b>Name:</b> ${user.name || currentUser.name}</p>
        <p><b>Email:</b> ${user.email || currentUser.email}</p>
        <p><b>Role:</b> ${user.role || currentUser.role}</p>
        <p><b>Enrolled Courses:</b></p>
        <ul>
            ${(user.enrolled_courses?.length)
                ? user.enrolled_courses.map(c => `<li>${c}</li>`).join("")
                : "<li>None yet</li>"}
        </ul>
    `;
}
</script>

</body>
</html>